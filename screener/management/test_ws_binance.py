import websocket
import json
import pandas as pd
import requests
from datetime import timedelta, datetime
from collections import deque
import time

from ..config import *

# –£–∫–∞–∂–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞ –∏ chat_id
telegram_token = TELEGRAM_BOT_TOKEN
chat_id = TELEGRAM_CHAT_ID
chat_id2 = TELEGRAM_CHAT_ID
chat_list = [chat_id2, chat_id]


def send_telegram_message(message) -> None:
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
    url = f'https://api.telegram.org/bot{telegram_token}/sendMessage'
    payload = {
        'chat_id': chat_id,
        'text': message,
        'parse_mode': 'Markdown'
    }
    requests.post(url, data=payload)

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
n_minutes = 5  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ n –º–∏–Ω—É—Ç
increase_percentage_volume = 10  # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
increase_percentage_price = 5  # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
increase_threshold_liquidations = 5  # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–π

# –û—á–µ—Ä–µ–¥–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–º–æ–≤, —Ü–µ–Ω –∏ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–π
volume_history = deque()
price_history = deque()
liquidation_history = deque()


class BinanceWebSocket:

    def __init__(
            self,
            token: str,
            chat_id: str,
            minimum_total_dollars: int = 0,
            time_frame_minutes: int = 5,
            minimum_percentage_increase: int = 10
    ) -> None:

        symbol = "btcusdt"
        interval = "1m"

        # self.socket = 'wss://fstream.binance.com/ws/!forceOrder@arr'
        # self.socket = 'wss://fstream.binance.com/ws/!ETH@markPrice'
        # self.socket = 'wss://fstream.binance.com/ws/BTC@openInterest@260325'
        # self.socket = 'wss://nbstream.binance.com/eoptions/ws/option_pair/ETH@markPrice/BTC@openInterest@221125'
        # self.socket = 'wss://nbstream.binance.com/eoptions/ws/ETH@openInterest@250325/BTC@openInterest@250325'
        # self.socket = f"wss://fstream.binance.com/ws/!forceOrder@arr"
        # self.socket = 'wss://nbstream.binance.com/eoptions/stream?streams=ETH@openInterest@221125'
        symbol = "btcusdt"
        interval = "1m"
        self.socket = f"wss://stream.binance.com:9443/ws/{symbol}@kline_{interval}"
        self.minimum_total_dollars = minimum_total_dollars
        self.minimum_percentage_increase = minimum_percentage_increase
        self.set_ticker = None
        self.data_list = []
        self.previous_volumes_df = pd.DataFrame(columns=['Symbol', 'Last Update', 'Total($)', 'Cumulative Total($)'])
        self.time_frame_minutes = time_frame_minutes
        self.time_frame = timedelta(minutes=time_frame_minutes)
        self.telegram_bot_token = token
        self.telegram_chat_id = chat_id
        self.ws = websocket.WebSocketApp(self.socket, on_message=self.on_message, on_error=self.on_error,
                                         on_close=self.on_close)
        self.ws.on_open = self.on_open

    def send_telegram_message(self, message: str) -> None:
        url = f'https://api.telegram.org/bot{self.telegram_bot_token}/sendMessage'
        payload = {
            'chat_id': self.telegram_chat_id,
            'text': message
        }
        requests.post(url, data=payload)

    def on_message(ws, message, check):
        global volume_history, price_history, liquidation_history
        # data = json.loads(message)
        print('data', message)
        print('check', check)

        # # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑ –∫–∞–∫–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –º—ã –ø–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        # if 'k' in data:
        #     current_volume = float(data['k']['v'])  # –û–±—ä–µ–º —Ç–µ–∫—É—â–µ–π —Å–≤–µ—á–∏
        #     current_price = float(data['k']['c'])  # –¶–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—É—â–µ–π —Å–≤–µ—á–∏
        #
        #     # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –æ–±—ä–µ–º –∏ —Ü–µ–Ω—É –≤ –∏—Å—Ç–æ—Ä–∏—é
        #     volume_history.append(current_volume)
        #     price_history.append(current_price)
        #
        # elif 'e' in data and data['e'] == 'forceOrder':  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏
        #     current_liquidations = int(data['o'])
        #
        #     # –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
        #     liquidation_history.append(current_liquidations)
        #
        # # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–µ–≤—ã—à–∞—é—Ç n –º–∏–Ω—É—Ç
        # while len(volume_history) > n_minutes:
        #     volume_history.popleft()
        # while len(price_history) > n_minutes:
        #     price_history.popleft()
        # while len(liquidation_history) > n_minutes:
        #     liquidation_history.popleft()
        #
        # if len(volume_history) == n_minutes and len(price_history) == n_minutes:
        #     # –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–æ–≤
        #     last_volume = volume_history[-1]
        #     first_volume = volume_history[0]
        #
        #     if first_volume > 0:
        #         percentage_increase_volume = ((last_volume - first_volume) / first_volume) * 100
        #         if percentage_increase_volume >= increase_percentage_volume:
        #             msg = f"–û–±—ä–µ–º —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ {percentage_increase_volume:.2f}% –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {n_minutes} –º–∏–Ω—É—Ç."
        #             print(msg)
        #             send_telegram_message(msg)
        #
        #     # –ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω
        #     last_price = price_history[-1]
        #     first_price = price_history[0]
        #
        #     if first_price > 0:
        #         percentage_increase_price = ((last_price - first_price) / first_price) * 100
        #         if percentage_increase_price >= increase_percentage_price:
        #             msg = f"–¶–µ–Ω–∞ —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å –Ω–∞ {percentage_increase_price:.2f}% –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {n_minutes} –º–∏–Ω—É—Ç."
        #             print(msg)
        #             send_telegram_message(msg)
        #
        # if len(liquidation_history) == n_minutes:
        #     last_liquidations = liquidation_history[-1]
        #     first_liquidations = liquidation_history[0]
        #
        #     if first_liquidations > 0:
        #         percentage_increase_liquidations = ((last_liquidations - first_liquidations) / first_liquidations) * 100
        #         if percentage_increase_liquidations >= increase_threshold_liquidations:
        #             msg = f"–õ–∏–∫–≤–∏–¥–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–∏–ª–∏—Å—å –Ω–∞ {percentage_increase_liquidations:.2f}% –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {n_minutes} –º–∏–Ω—É—Ç."
        #             print(msg)
        #             send_telegram_message(msg)

    def check_liquidations(self, data):
        """–ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–π"""
        order_data = data['o']
        trade_time = pd.to_datetime(order_data['T'], unit='ms', utc=True).tz_convert('Europe/Kaliningrad')

        # –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ä—à–µ –æ–¥–Ω–æ–≥–æ —á–∞—Å–∞
        one_hour_ago = pd.Timestamp.now(tz='Europe/Kaliningrad') - pd.Timedelta(hours=1)
        self.previous_volumes_df = self.previous_volumes_df[self.previous_volumes_df['Last Update'] > one_hour_ago]

        new_row = {
            'Symbol': order_data['s'],
            'Side': order_data['S'],
            'Price': float(order_data['p']),
            'Quantity': float(order_data['q']),
            'Total($)': round(float(order_data['p']) * float(order_data['q']), 2),
            'Trade Time': trade_time.strftime('%Y-%m-%d %H:%M:%S')
        }

        key = new_row['Symbol']
        total_liquidations = new_row['Total($)']

        if key in self.previous_volumes_df['Symbol'].values:
            previous_row = self.previous_volumes_df[self.previous_volumes_df['Symbol'] == key].iloc[0]
            previous_time = previous_row['Last Update']
            previous_total = previous_row['Total($)']
            cumulative_total = previous_row['Cumulative Total($)'] + total_liquidations

            if (trade_time - previous_time).total_seconds() / 60 >= self.time_frame_minutes:
                percentage_increase = (total_liquidations - previous_total) / previous_total * 100
                if percentage_increase >= self.minimum_percentage_increase:
                    msg = (f"üìâ {key} —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–π –Ω–∞ {percentage_increase:.2f}% "
                           f"–∑–∞ {self.time_frame_minutes} –º–∏–Ω—É—Ç")
                    print(msg)
                    self.send_telegram_message(msg)

            self.previous_volumes_df.loc[
                self.previous_volumes_df['Symbol'] == key, ['Last Update', 'Total($)', 'Cumulative Total($)']] = (
                trade_time, total_liquidations, cumulative_total)
        else:
            cumulative_total = total_liquidations  # –ü–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—ã
            new_volume_row = pd.DataFrame([[key, trade_time, total_liquidations, cumulative_total]],
                                          columns=['Symbol', 'Last Update', 'Total($)', 'Cumulative Total($)'])
            self.previous_volumes_df = pd.concat([self.previous_volumes_df, new_volume_row], ignore_index=True)

        if ((self.set_ticker is None or new_row['Symbol'] in self.set_ticker)
                and new_row['Total($)'] >= self.minimum_total_dollars):
            self.data_list.append(new_row)
            df = pd.DataFrame(self.data_list)
            print(df)
            print("")
            print(self.previous_volumes_df)
            print("")
        else:
            print("Error: Please check the filter.")

    # def check_volume(self, data):
    #     """–ü–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–º"""
    #     global volume_history
    #     print('check_volume')
    #     current_volume = float(data['k']['v'])  # –û–±—ä–µ–º —Ç–µ–∫—É—â–µ–π —Å–≤–µ—á–∏
    #
    #     # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    #     volume_history.append(current_volume)
    #
    #     # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—ä–µ–º—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
    #     while len(volume_history) > n_minutes:
    #         volume_history.popleft()
    #
    #     # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —É –Ω–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    #     if len(volume_history) == n_minutes:
    #         # –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—ä–µ–º
    #         last_volume = volume_history[-1]
    #         # –ü–µ—Ä–≤—ã–π –æ–±—ä–µ–º
    #         first_volume = volume_history[0]
    #
    #         # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
    #         if first_volume > 0:
    #             percentage_increase = ((last_volume - first_volume) / first_volume) * 100
    #             if percentage_increase >= increase_percentage:
    #                 mess = f"–û–±—ä–µ–º —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ {percentage_increase:.2f}% –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {n_minutes} –º–∏–Ω—É—Ç."
    #                 print(mess)

    def on_error(self, ws: websocket.WebSocketApp, error: Exception) -> None:
        print('Error:', error)

    def on_close(self, ws: websocket.WebSocketApp) -> None:
        print('Connection closed')

    def on_open(self, ws: websocket.WebSocketApp) -> None:

        # –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º time.time()
        current_timestamp_ms = int(time.time() * 1000)
        print("Timestamp (ms) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º time.time():", current_timestamp_ms)
        print('Connection opened')

    def run(self) -> None:
        self.ws.run_forever()


binance_ws = BinanceWebSocket(TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID)
binance_ws.run()
